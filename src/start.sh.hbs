#! {{shell}}

tmux start-server;

cd {{root}}

{{#if on_project_start}}
	{{{on_project_start}}}
{{/if}}

{{#if (not(has_session name))}}
	{{#if on_project_first_start}}
		{{{on_project_first_start}}}
	{{/if}}

	tmux new-session -d -s {{name}}

	# TODO Support a non-root start location
	# Setup the windows
	{{#each windows}}
		{{#if @first}}
			tmux rename-window -t {{@root.name}}:0 {{name}}
		{{else}}
			tmux new-window -t {{@root.name}}:{{@index}} -n {{name}} -c {{@root.root}}
		{{/if}}

		{{#if @root.pre_window}}
			tmux send-keys -t {{@root.name}}:{{@../index}} '{{{@root.pre_window}}}' C-m
		{{/if}}

		# Run each of the configured commands for the window
		{{#each commands}}
			tmux send-keys -t {{@root.name}}:{{@../index}} '{{{this}}}' C-m
		{{/each}}
	{{/each}}

	{{#if startup_window}}
		tmux select-window -t {{name}}:{{startup_window}}
	{{/if}}
{{else}}

	{{#if on_project_restart}}
		{{{on_project_restart}}}
	{{/if}}

{{/if}}

tmux -u attach-session -t {{name}}

{{#if on_project_exit}}
	{{{on_project_exit}}}
{{/if}}
